{# ============================================================
   base.html · Grundgerüst für alle Seiten
   Enthält: Navbar, Footer, globale Styles/Scripts, CSP-nonce
   ============================================================ #}
<!doctype html>
<html lang="es"
      data-bs-spy="scroll"
      data-bs-target="#mainNav"
      data-bs-offset="80"
      {% if request.cookies.get('theme') %}
        data-theme="{{ request.cookies.get('theme') }}"
      {% endif %}>

  <head>
    <meta charset="utf-8">
    <!-- Bloqueo de zoom -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>{% block title %}Casa de Playa Alcossebre{% endblock %}</title>

    <!-- ─────  ESTILOS GLOBALES  ───── -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/app.css') }}">
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/login.css') }}">

    {# Seite kann zusätzliche <link>/<style>/<script> in head injizieren #}
    {% block head_extra %}{% endblock %}
  </head>

  <body class="d-flex flex-column min-vh-100" style="touch-action: manipulation">

    <!-- ═════ NAVBAR ═════ -->
    <nav id="mainNav" class="navbar navbar-dark bg-transparent fixed-top">
      <div class="container-fluid justify-content-end position-relative">

        {% if next_arrival %}
          <span id="countdownBadge"
                class="badge rounded-pill bg-success position-absolute top-0 start-0 ms-3 mt-3">
            Llegada en …
          </span>
        {% endif %}

        <!-- Botón de tema -->
        <button id="themeToggle"
                class="btn btn-outline-light me-2"
                type="button"
                aria-label="Cambiar tema">
          <i class="fa-solid fa-moon"></i>
        </button>

        <!-- Menú de usuario -->
        {% if current_user.is_authenticated %}
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
              {{ current_user.name }}
              {% if days_to_arrival is not none %}
                <span class="badge bg-success ms-2">{{ days_to_arrival }}</span>
              {% endif %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              {% for u in current_user.query.order_by('last_name', 'first_name') %}
                <li>
                  <a class="dropdown-item"
                     href="{{ url_for('auth.switch_user', user_id=u.id) }}">{{ u.name }}</a>
                </li>
              {% endfor %}
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item text-danger"
                   href="{{ url_for('auth.logout') }}">Cerrar sesión</a>
              </li>
            </ul>
          </div>
        {% endif %}
      </div>
    </nav>

    <!-- ═════ CONTENIDO ESPECÍFICO DE CADA VISTA ═════ -->
    <main class="flex-grow-1 pt-5">
      {% block content %}{% endblock %}
    </main>

    {# Platz für optionale Modals (Login, Booking …) #}
    {% block modal %}{% endblock %}

    <!-- ═════ FOOTER ═════ -->
    <footer class="bg-dark text-white mt-auto py-3">
      <div class="container text-center small">
        © {{ 2025 }} Familia Lahiguera · Tonev · Habegger
      </div>
    </footer>

    <!-- ─────  SCRIPTS GLOBALES  ───── -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            nonce="{{ csp_nonce() }}" defer></script>

    <!-- Alternancia de tema (inline para Early-Execution) -->
    <script nonce="{{ csp_nonce() }}">
      (() => {
        const root   = document.documentElement;
        const toggle = document.getElementById('themeToggle');
        const icon   = toggle.querySelector('i');
        const key    = 'theme';

        const saved      = localStorage.getItem(key);
        const systemPref = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        const startTheme = saved || systemPref;
        root.dataset.theme = startTheme;
        icon.classList.toggle('fa-sun',  startTheme === 'light');
        icon.classList.toggle('fa-moon', startTheme === 'dark');

        toggle.addEventListener('click', () => {
          const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
          root.dataset.theme = next;
          localStorage.setItem(key, next);
          icon.classList.toggle('fa-sun',  next === 'light');
          icon.classList.toggle('fa-moon', next === 'dark');
        });
      })();
    </script>

    <script src="{{ url_for('static', filename='js/site.js') }}"
            nonce="{{ csp_nonce() }}" defer></script>

    {# Jede Seite kann zusätzliche Skripte anhängen #}
    {% block extra_js %}{% endblock %}
  </body>
</html>
